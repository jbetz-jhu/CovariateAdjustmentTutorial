---
title: "Covariate Adjustment in Randomized Trials"
subtitle: "Worked Examples using Time-to-Event Clinical Trial Data"
author: "Josh Betz (jbetz@jhu.edu), Kelly Van Lancker (kvanlan3@jhu.edu), and Michael Rosenblum (mrosen@jhu.edu)"
# date: "`r format(Sys.time(), '%Y-%m-%d %I:%M')`"
header-includes:
   - \usepackage{amsmath}
output:
  github_document:
    toc: true
bibliography: covariate_adjustment.bib # For Bibliography - In same folder
# csl: biomed-central.csl # For citation style - In same folder
---

<style type="text/css">
.main-container {
  max-width: 100% !important;
  margin: auto;
}
</style>

```{r Setup, echo = FALSE, message = FALSE}
# Packages used for formatting, not needed for analysis
library(pander)

### Graphics and Report Options ################################################
table_digits <- 1 # Significant Figures for Mean/SD, N (%), Median/IQR

root_url <- "https://jbetz-jhu.github.io/CovariateAdjustmentTutorial"

bootstrap_tutorial_url <-
  paste0(root_url, "/bootstrap_tutorial.html")

survival_colon_cancer_url <-
  paste0(root_url, "/blob/main/create_moertel_cancer_data.r")

estimands_tutorial_url <-
  paste0(root_url, "/blob/gh-pages/Estimands_of_Interest.html")

estimators_tutorial_url <-
  paste0(root_url, "/blob/gh-pages/Estimators.html")




### Set Default Options ########################################################
options(
  knitr.kable.NA = "",
  width = 300
)



### Set Default Options ########################################################
fig_w <- 8
fig_h <- 8

knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  results = "markup",
  fig.width = fig_w,
  fig.height = fig_h,
  fig.align = "center",
  out.width = "80%",
  dpi = 600,
  dev = "CairoPNG"
)
```


## Executive Summary

Randomly allocating participants to treatment arms will tend to produce groups that are initially comparable to one another across both observed and unobserved factors. In any given randomized trial, there will be some degree of imbalance in the distribution of baseline covariates between treatment groups. When a variable is a strong predictor of the outcome and is imbalanced across treatment arms, it represents a potential confounding variable and source of bias, even if these differences are not statistically significant [@Assmann2000]. Confounding can be addressed both in the design phase of a trial, using stratified randomization to lessen the potential for imbalance, and in during the analysis phase, through covariate adjustment.


Covariate adjustment can lead to a more efficient trial, potentially lowering the required sample size to detect a given treatment effect if it exists, or provide greater precision (shorter confidence interval widths and higher power) for the same sample size and treatment effect. When stratified randomization is used, covariate adjustment is generally suggested, but not always implemented, which can lead to reduced power and precision [@Kahan2011]. Accessible and practical discussions of baseline balance, stratified randomized trials, and adjusted analyses are also available to offer further explanation and guidance to investigators [@Kernan1999, @Assmann2000].


When using regression models for inference, it is important to understand how model misspecification may affect statistical inference. Fortunately, there are several approaches to covariate-adjusted analyses whose validity does not depend on a correctly specified model, or provide inference with greater robustness to misspecification than those used in common practice.


**The focus of this template is on the analysis of time-to-event outcomes.** This tutorial illustrates the use of covariate-adjusted analysis in clinical trials using an example dataset from a randomized trial of treatments for colon cancer. This tutorial illustrates calculating the restricted mean survival time (RMST) and survival probability with and without adjustment for covariates. These methods are contrasted against methods commonly used in observational studies and randomized trials, such as the logrank test and Cox Proportional Hazards model.




#### Using This Tutorial

This tutorial contains an example dataset as well as code to illustrate how to perform covariate adjustment in practice for continuous and binary outcomes using [R](https://www.r-project.org/). R is a free and open source language and statistical computing environment. [Rstudio](https://rstudio.com/) is a powerful development environment for using the R language. The ability of R can be extended by downloading software packages from the [Comprehensive R Archival Network (CRAN)](https://cran.r-project.org/). In R, these packages can be installed from the Comprehensive R Archival Network, or CRAN, using the `install.packages()` command. In Rstudio IDE, there is a 'Packages' tab that allows users to see which packages are installed, which packages are currently in use, and install or update packages using a graphical interface. Once the required packages are installed, data can be downloaded from Github, and users can run the code on their own devices.




## Covariate Adjusted Analysis in Practice

Once R and Rstudio have been installed, additional packages must be installed from CRAN or Github, and some tools may need to be installed to compile packages from source code.


### Installing RTools - Compiling Packages from Source

Some R packages must be compiled from source code. [RTools](https://cran.r-project.org/bin/windows/Rtools/) is a set of software tools for compiling such R packages. Choose the appropriate version of RTools for your version of R.


### Installing R Packages from CRAN

The following packages and their dependencies needs to be installed:

  - [knitr](https://cran.r-project.org/web/packages/knitr/index.html) - Tools for literate programming: including code in reproducible reports
  - [devtools](https://cloud.r-project.org/web/packages/devtools/index.html) - A suite of tools for R package development
  - [tidyverse](https://www.tidyverse.org/packages/) - An ecosystem of packages for working with data
  - [table1](https://cran.r-project.org/web/packages/table1/index.html) - Creating simple tabulations in aggregate and by treatment arm
  - [survminer](https://cran.r-project.org/web/packages/survminer/index.html) - Creating plots of time-to-event data
  - [survRM2](https://cran.r-project.org/web/packages/survRM2/index.html) - Calculating the restricted mean survival time (RMST) with and without covariate adjustment.
  

```{r install-packages, eval = FALSE}
required_packages <-
  c("knitr",
    "devtools",
    "tidyverse",
    "table1",
    "survminer",
    "coxrobust",
    "survRM2"
  )

install.packages(required_packages)
```

**NOTE:** Packages only need to be installed once: after installation, they can be updated using the 'Packages' tab in RStudio.



### Installing R Packages from GitHub

[Github](https://github.com/) is a platform for developing software and documentation with version control. It is a common platform for R package development, testing, reporting and addressing software issues. Use `devtools::install_github` to install packages hosted on Github.

```{r install-github, eval = FALSE}
devtools::install_github("nt-williams/simul")
devtools::install_github("nt-williams/adjrct")
```




### Loading Installed Packages

Once the required packages are installed, they can be loaded using `library()` command.


```{r load-packages}
library(knitr) # Printing tables in reports
library(tidyverse) # Data manipulation: dplyr, tidyr
library(table1) # Creation of Summary tables
library(survival) # For AFT & Cox Proportional Hazards Models
library(survminer) # For Kaplan-Meier Plots
library(coxrobust) # For coxr: Robust Cox PH Model
library(survRM2) # For restricted mean survival times (RMST)
library(adjrct) # For TMLE estimates of RMST, Survival Probability
library(splines) # For adding smoothing splines
```




## Chemotherapy for Stage B/C Colon Cancer

Data used in this example come from the `survival::colon` dataset, a trial of adjuvant chemotherapy for colon cancer. See `?survival::colon` for more details. In brief, the study had three treatment arms: observation, levamisole, and levamisole + 5-Fluorouracil.

These data have been pre-processed to make the data more usable. Event times were converted from long (one row per event type: recurrence vs. death) to wide (each event as separate columns instead of rows), categorical variables were cast as factors with named labels to make them easier to interpret, and since some individuals were followed up for 8 years or so, the scale of time was coarsened to months instead of days. The code for processing the data is available [here](`r survival_colon_cancer_url`)


```{r colon-data-from-survival-package, echo = FALSE}
data_url <-
  "https://github.com/jbetz-jhu/CovariateAdjustmentTutorial/raw/main/moertel_colon_cancer_trial.RData"

load(file = url(data_url))
```




  - `id`: Patient id
  - Baseline Covariates
    - `arm`: Treatment - Obs(ervation), Lev(amisole), Lev(amisole)+5-FU
    - `age`: Age in years
    - `sex`: Patient Sex
    - `obstruction`:	obstruction of colon by tumor
    - `perforation`:	perforation of colon
    - `adherence`:	adherence to nearby organs
    - `positive_nodes`: number of lymph nodes with detectable cancer
    - `differentiation`:	differentiation of tumor (`1. Well`, `2. Moderate`, `3. Poor`)
    - `extent`:	Extent of local spread (`1. Submucosa`, `2. Muscle`, `3. Serosa`, `4. Contiguous structures`)
    - `time_surgery_registration`:	time from surgery to registration
  - Outcome:
    - `event_recurrence`:	Observed (1) or Censored (0)
    - `time_to_recurrence`:	days until recurrence event
    - `months_to_recurrence`:	months until recurrence event
    - `event_death`:	Observed (1) or Censored (0)
    - `time_to_death`:	days until recurrence event
    - `months_to_death`: months until recurrence event
    - `event_composite`: Observed death OR recurrence (1) or neither event (0)
    - `time_to_composite`: days until first composite event or censoring time
    - `months_to_composite`: days until first composite event or censoring time



Since some functions require a binary treatment indicator and the study contains three arms, we can create a dataset for each binary treatment comparison of interest:

```{r create-datasets-with-binary-treatment}
# Datasets with Binary Treatment ###############################################
# LEV vs Obs
colon_cancer_lev_vs_obs <-
  colon_cancer %>% 
  dplyr::filter(
    arm %in% c("Lev", "Obs")
  ) %>% 
  dplyr::mutate(
    tx = as.integer(1*(arm == "Lev"))
  )


# LEV+5FU vs LEV
colon_cancer_lev5fu_vs_lev <-
  colon_cancer %>% 
  dplyr::filter(
    arm %in% c("Lev", "Lev+5FU")
  ) %>% 
  dplyr::mutate(
    tx = as.integer(1*(arm == "Lev+5FU"))
  )


# LEV+5FU vs Obs
colon_cancer_lev5fu_vs_obs <-
  colon_cancer %>% 
  dplyr::filter(
    arm %in% c("Obs", "Lev+5FU")
  ) %>% 
  dplyr::mutate(
    tx = as.integer(1*(arm == "Lev+5FU"))
  )
```




### Baseline Demographics & Stratum

Below are summary statistics of participant characteristics at baseline.

```{r table-demographic-characteristics-original-code, eval = FALSE}
table1(
  ~ age + sex + obstruction + perforation + organ_adherence +
    differentiation + local_spread + time_surgery_registration +
    positive_nodes + recurrence + death + composite | arm, 
  data = colon_cancer_original
)
```

```{r table-demographic-characteristics-original-eval, echo = FALSE}
table1(
  ~ age + sex + obstruction + perforation + organ_adherence +
    differentiation + local_spread + time_surgery_registration +
    positive_nodes + recurrence + death + composite | arm, 
  data = colon_cancer_original,
  render.continuous = c(. = "Mean (SD)", . = "Median (Min, Max)")
) %>% 
  pander::pander()
```

Note that `differentiation` and `positive_nodes` contain missing values, which must be imputed. If there are any missing covariates, observations may be dropped from analyses, or these may cause errors in other functions.

Below are summary statistics of participant characteristics at baseline *after* imputing missing baseline covariates.

```{r table-demographic-characteristics-imputed-code, eval = FALSE}
table1(
  ~ age + sex + obstruction + perforation + organ_adherence +
    differentiation + local_spread + time_surgery_registration +
    positive_nodes + recurrence + death + composite | arm, 
  data = colon_cancer
)
```

```{r table-demographic-characteristics-imputed-eval, echo = FALSE}
table1(
  ~ age + sex + obstruction + perforation + organ_adherence +
    differentiation + local_spread + time_surgery_registration +
    positive_nodes + recurrence + death + composite | arm, 
  data = colon_cancer,
  render.continuous = c(. = "Mean (SD)", . = "Median (Min, Max)")
) %>% 
  pander::pander()
```




## Checks on the Data:

### Frequency of Events

Rare events may lead to numerical instabilities in estimation: it is always advisable to check whether the frequencies of events in aggregate and within categories of interest are sufficient for the planned analysis. For example, tabulations can assess whether there are sufficient events within `obstruction` to support analysis:


```{r table-events-by-arm-and-covariate-code, eval = FALSE}
table1(
  ~ recurrence + death + composite | differentiation:arm, 
  data = colon_cancer,
  overall = NULL
)
```

```{r table-events-by-arm-and-covariate-eval, echo = FALSE}
table1(
  ~ recurrence + death + composite | differentiation:arm, 
  data = colon_cancer,
  overall = NULL,
  render.continuous = c(. = "Mean (SD)", . = "Median (Min, Max)")
) %>% 
  pander::pander()
```




### Reference level for Treatment

When the treatment is a `factor` variable, we can use the `levels()` function to see the reference level (i.e. the comparator/control group): it will appear as the first level.

```{r check-reference-level}
# Check reference level
levels(colon_cancer$arm)
```

**Make sure that the reference level is appropriately chosen before running analyses to avoid errors in interpretation and inference.**




--------------------------------------------------------------------------------




## Types of Tests & Estimators: Time-to-Event Outcomes

The Kaplan-Meier (K-M) estimate of the survival function is a ubiquitous approach to estimating and visualizing the survival probability, i.e. the probability of not having an event of interest, over a follow-up period. The K-M estimator assumes that censoring is independent of the event time within each treatment arm, which may be violated if certain baseline characteristics, such as disease severity, are associated with both the event time of interest and dropout [@Diaz2018]. This could occur if individuals with greater baseline severity are more likely to have the event and more likely to drop out before the event is observed.

The logrank test is perhaps the most common method for performing sample size calculations and performing unadjusted comparisons of time-to-event outcomes. The logrank test is valid if censoring is independent of the treatment or independent of the event time in each treatment arm [@VanLancker2021]. The logrank test is most powerful under the proportional hazards assumption. When the proportional hazards assumption is violated, a weight function can be specified in a weighted logrank test to emphasize different domains of the survival curve. For more on the use of weighted logrank tests to address violations of the proportional hazards, see @Lin2017.

The Cox Proportional Hazards (PH) regression is the most common method for performing covariate-adjusted comparisons of time-to-event outcomes under the proportional hazards assumption. The logrank test is equivalent to the Score test in a Cox PH model which only includes a treatment indicator and no additional covariates. Inclusion of covariates allows relaxation of the uninformative censoring assumption, but raises concerns about the impact of model assumptions and specification.

The validity of tests for the hypothesis of no treatment effect in randomized experiments using the Cox PH model depends on the relationship of censoring times to the treatment assignment and covariates. If censoring times are conditionally independent of treatment assignment given the covariates, or conditionally independent of the covariates given the treatment assignment, tests are valid when the sandwich variance estimator is used. However, if the model is mispecified and the distribution of censoring times depends on both the treatment and covariates, tests based on the Cox model will not be valid, and alternatives should be considered [@DiRienzo2001].

When the proportional hazards assumption is violated, the estimates from a Cox PH model represent a weighted average of the hazard functions over time. The weights in this weighted average are determined by both the survival in each group and the censoring distribution. This dependence upon the censoring distribution makes it difficult to meaningfully interpret the estimate when there are appreciable violations of the PH assumption [@Rudser2012].

Even in the situation when the proportional hazards assumption appears to hold, the clinical interpretation of the hazard ratio is not straightforward. In the absence of censoring, measures of a treatment effect are usually based on summaries of the outcome distribution that explicitly reference the scale of measurement of the outcome which facilitate evaluation of clinical importance, such as the mean, median, or proportion above or below a clinically meaningful threshold [@Rudser2012]. The hazard function is the instantaneous rate at which events occur, which changes over time, and does not quantify the expected length of time until the event [@Rudser2012].

Since quantities such as survival probabilities (e.g. survival at 5 years), quantiles (e.g. median, 75^th^ percentile), or the restricted mean survival time (RMST, e.g. average time without an event in the 5 yeras post randomization) explicitly reference the time frame of events, they may be more clinically meaningful for comparing treatments [@Rudser2012]. Survival probability and RMST are interpretable under violations of the proportional hazards assumption, and estimators for these quantities exist that are doubly robust (i.e. consistent if either the censoring or survival distributions are consistently estimated) and are at least as efficient as the K-M estimator [@Diaz2018].

While covariate-adjusted hazard ratios can be obtained from a Cox PH model, these are conditional treatment effects: they are the estimated hazard ratio given all of the covariates in the model. Covariate adjusted estimators of the survival probability and RMST are marginal treatment effects, which are useful for assessing the public health impact of an intervention on the intended use population. For more information on estimands and estimators for survival data, see the pages on [estimands](`r estimands_tutorial_url`) and [estimators and models](`r estimators_tutorial_url`).




--------------------------------------------------------------------------------





## Implementing Unadjusted Tests & Models

### Kaplan-Meier Survival Estimate: Death

#### KM for Death - Time Scale: Days

```{r kaplan-meier-death-days}
time_to_death_km <-
  survfit(
      formula = Surv(time_to_death, event_death) ~ arm,
      data = colon_cancer
    )

ggsurvplot(
  fit = time_to_death_km,
  conf.int = TRUE,
  risk.table = TRUE,
  surv.median.line = "hv",
  break.time.by = 365.25,
  xlab = "Days", 
  ylab = "Overall survival probability"
)
```




#### KM for Death - Time Scale: Months

```{r kaplan-meier-death-months}
months_to_death_km <-
  survfit(
      formula = Surv(months_to_death, event_death) ~ arm,
      data = colon_cancer
    )

ggsurvplot(
  fit = months_to_death_km,
  conf.int = TRUE,
  risk.table = TRUE,
  surv.median.line = "hv",
  break.time.by = 12,
  xlab = "Months", 
  ylab = "Overall survival probability"
)
```


Note that numbers at will not exactly match across plots: actual calendar months vary in length from 28 to 31 days, while the time scale is coarsened by periods of (365.25/12 $\approx$ 30.4) days.




#### KM for Death - Stratified by `obstruction`

```{r kaplan-meier-death-obstruction, fig.width = 2.5*fig_w}
ggsurvplot(
  fit = time_to_death_km,
  conf.int = TRUE,
  surv.median.line = "hv",
  break.time.by = 365,
  facet.by = "differentiation",
  xlab = "Days", 
  ylab = "Overall survival probability"
) +
  theme(
    # Adjust Plot Labels for Readability
    axis.text.x = element_text(size = 18),
    axis.text.y = element_text(size = 18),
    axis.title.y = element_text(size = 26),
    axis.title.x = element_text(size = 26),
    strip.text = element_text(size = 26),
    legend.text = element_text(size = 22),
    legend.title = element_text(size = 22)
  )
```




### Logrank Test

The logrank test (and the G-rho family of rank-based test procedures) can be obtained using `survival::survdiff`:

```{r unadjusted-logrank-test}
survival::survdiff(
  formula = Surv(months_to_death, event_death) ~ arm,
  data = colon_cancer
)
```




### Cox Proportional Hazards Model

The Cox Proportional Hazards model can be fit using the `survival::coxph` function. Robust standard errors can be utilized with the argument `robust = TRUE`.

```{r unadjusted-cox}
unadjusted_cox <-
  survival::coxph(
    formula = Surv(months_to_death, event_death) ~ arm,
    # Use Efron's Method for Tied Event Times
    ties = "efron",
    # Use Robust Standard Errors
    robust = TRUE,
    data = colon_cancer
  )

summary(unadjusted_cox)
```

Assuming the proportional hazards assumption is correct, the hazard of death in those receiving Lev+5FU was 31% lower (`(1 - 0.68929) = 0.31071`) than the observation arm.


The Proportional Hazards (PH) assumption can be assessed using `survival::cox.zph`:

```{r unadjusted-cox-ph-test}
unadjusted_cox_ph_test <- cox.zph(unadjusted_cox)

print(unadjusted_cox_ph_test)

# Plot 
plot(cox.zph(unadjusted_cox))
```

These plots should show an approximately constant value over time when the proportional hazards assumption holds.




### Robust Cox Proportional Hazards Model

The `coxrobust` package has the `coxr` package for fitting a robust Cox proportional hazard model, based on a smooth modification of the partial likelihood (see `?coxrobust::coxr` for details).

```{r unadjusted-robust-cox}
unadjusted_robust_cox <-
  coxr(
    formula = Surv(months_to_death, event_death) ~ arm,
    data = colon_cancer
  )

unadjusted_robust_cox_table <- 
  with(unadjusted_robust_cox,
       data.frame(
         Beta = coefficients,
         SE = sqrt(diag(unadjusted_robust_cox$var))
       )
  ) %>% 
  dplyr::mutate(
    `Beta LCL` = Beta + qnorm(p = 0.025)*SE,
    `Beta UCL` = Beta + qnorm(p = 0.0975)*SE,
    HR = exp(Beta),
    `HR LCL` = exp(`Beta LCL`),
    `HR UCL` = exp(`Beta UCL`)
  )

unadjusted_robust_cox_table %>% 
  kable(
    x = .,
    digits = 2,
    caption = "Estimates from a Robust Cox Proportional Hazards Model."
  )
```

Using the robust Cox PH model, the hazard of death in those receiving Lev+5FU was 25% lower (`(1 - exp(-0.29)) = 0.2517364`) than the observation arm. Alternatively, the hazard of death was 33% higher `exp(-(-0.29)) = 1.336427` in the observation arm relative to the Lev+5FU arm.




### Restricted Mean Survival Time: `survRM2::rmst2`

```{r unadjusted-restricted-mean-survival-time-rmst2}
with(
  colon_cancer_lev5fu_vs_obs,
  survRM2::rmst2(
    time = months_to_death,
    status = event_death,
    arm = tx,
    tau = 60
  )
)
```

The average survival time in the first 60 months was 47.84 months in the Lev+5FU arm and 44.24 months in the observation arm: the difference in average time without an event (RMST) between arms in the first 60 months was 3.6 months. The ratio of RMST between treatment and control was 1.081 (8% increase in RMST), and the mean difference in life expectancy lost to death (Restricted Mean Time Lost or RMTL) was 0.77 months.




### Targeted Maximum Likelihood Estimator (TMLE): `adjrct::survrct`

The first step in using `adjrct::survrct` is to compute the metadata necessary for computing the model-robust estimates of restricted mean survival time and survival probability:

```{r unadjusted-tmle-adjrct}
surv_metadata_unadj <-
  adjrct::survrct(
    outcome.formula = Surv(months_to_death, event_death) ~ tx, 
    trt.formula = tx ~ 1,
    data = colon_cancer_lev5fu_vs_obs,
  )
```




#### Unadjusted Restricted Mean Survival Time (RMST)

```{r unadjusted-tmle-survival-rmst-adjrct}
adjrct::rmst(
  metadata = surv_metadata_unadj,
  horizon = 60
)
```

The average survival time in the first 60 months was 47.84 months in the Lev+5FU arm and 44.24 months in the observation arm: the difference in average time without an event between arms was 3.6 months.




#### Unadjusted Survival Probability

```{r unadjusted-tmle-survival-probability-adjrct}
adjrct::survprob(
  metadata = surv_metadata_unadj,
  horizon = 60
)
```

The unadjusted survival probability in the first 60 months was 0.63 in the in the Lev+5FU arm and 0.53 in the observation arm. The difference in the probability of surviving the first 60 months between Lev+5FU and observation was 0.11 (i.e an 11% lower risk of dying in the first 60 months in the treatment arm relative to control).




--------------------------------------------------------------------------------




## Covariate Adjusted Analyses


### Propensity Score

```{r propensity-score-glm}
ps_model <-
  glm(
    formula =
      tx ~ age + positive_nodes +
      sex + obstruction + organ_adherence + differentiation +
      local_spread,
    data = colon_cancer_lev5fu_vs_obs,
    family = binomial(link = "logit")
  )

summary(ps_model)
```




### Adjusted Cox Proportional Hazards Model

```{r adjusted-cox}
adjusted_cox <-
  coxph(
    formula = Surv(months_to_death, event_death) ~ arm +
      # Covariates
      pspline(age) + pspline(positive_nodes) +
      sex + obstruction + organ_adherence + differentiation +
      local_spread,
    # Use Efron's Method for Tied Event Times
    ties = "efron",
    # Use Robust Standard Errors
    robust = TRUE,
    data = colon_cancer
  )
```

Assuming the proportional hazards assumption holds, conditioning on `age`, `positive_nodes`, `sex`, `obstruction`, `organ_adherence`, `differentiation`, and `local_spread`, the hazard of death in those receiving Lev+5FU was 33% lower (`(1 - exp(-0.400301)) = 0.3298817`) than the observation arm. Note that this is also a conditional treatment effect, not a marginal treatment effect.

```{r adjusted-cox-proportional-hazards}
cox.zph(
  fit = adjusted_cox
)
```

Here we can see that `obstruction`, `differentiation`, and `local_spread` suggest departures from the proportional hazards assumption:


```{r adjusted-cox-proportional-hazards-plot}
cox.zph(
  fit = adjusted_cox
) %>% 
  plot(var = "differentiation")
abline(h = 0, col = rgb(1, 0, 0, 0.75))
```

Note that the sign of the coefficient is initially large and positive, decreases with time, and eventually becomes negative in sign.

```{r adjusted-cox-wald-tests}
summary(adjusted_cox)
```



### Adjusted Robust Cox Proportional Hazards Model

```{r adjusted-robust-cox}
adjusted_robust_cox <-
  coxr(
    formula = Surv(months_to_death, event_death) ~ arm +
      # Covariates
      bs(age) + bs(positive_nodes) +
      sex + obstruction + organ_adherence + differentiation +
      local_spread,
    data = colon_cancer
  )

adjusted_robust_cox_table <- 
  with(adjusted_robust_cox,
       data.frame(
         Beta = coefficients,
         SE = sqrt(diag(unadjusted_robust_cox$var))
       )
  ) %>% 
  dplyr::mutate(
    `Beta LCL` = Beta + qnorm(p = 0.025)*SE,
    `Beta UCL` = Beta + qnorm(p = 0.0975)*SE,
    HR = exp(Beta),
    `HR LCL` = exp(`Beta LCL`),
    `HR UCL` = exp(`Beta UCL`)
  )

adjusted_robust_cox_table %>% 
  kable(
    x = .,
    digits = 2,
    caption = "Estimates from a Robust Cox Proportional Hazards Model."
  )
```

Assuming the proportional hazards assumption holds, conditioning on `age`, `positive_nodes`, `sex`, `obstruction`, `organ_adherence`, `differentiation`, and `local_spread`, the hazard of death in those receiving Lev+5FU was 26% lower (`(1 - exp(-0.30)) = 0.2591818`) than the observation arm using the robust Cox PH model. Note that this is also a conditional treatment effect, not a marginal treatment effect.




--------------------------------------------------------------------------------




### Targeted Maximum Likelihood

```{r tmle}
surv_metadata_adj <-
  adjrct::survrct(
    outcome.formula = Surv(months_to_death, event_death) ~ tx +
      age + positive_nodes +
      sex + obstruction + organ_adherence + differentiation +
      local_spread,
    trt.formula =
      tx ~ age + positive_nodes +
      sex + obstruction + organ_adherence + differentiation +
      local_spread,
    data = colon_cancer_lev5fu_vs_obs
  )
```




#### Calculate Restricted Mean Survival Time

```{r tmle-adjusted-rmst, results = 'asis', message = TRUE}
rmst_metadata_adj <-
  adjrct::rmst(
    metadata = surv_metadata_adj,
    horizon = 60
  )

rmst_metadata_adj
```


The covariate-adjusted average survival time in the first 60 months was 47.74 months in the Lev+5FU arm and 44.53 months in the observation arm: the difference in average time without an event between arms was 3.2 months. While the point estimates are similar to the unadjusted estimate, the variance of the estimate is reduced by about 13% $1 - ({SE}_{Unadj}/{SE}_{Adj})^{2}$ = `1 - (1.43/1.53)^2 = 0.1264471.`


```{r tmle-adjusted-rmst-format}
rmst_metadata_adj_table <-
  with(
    rmst_metadata_adj$estimates[[1]],

    bind_rows(
      data.frame(
        Arm = "Treatment",
        Estimate = arm1,
        SE = arm1.std.error,
        LCL = arm1.conf.low,
        UCL = arm1.conf.high
      ),

      data.frame(
        Arm = "Control",
        Estimate = arm0,
        SE = arm0.std.error,
        LCL = arm0.conf.low,
        UCL = arm0.conf.high
      ),
      data.frame(
        Arm = "Treatment - Control",
        Estimate = theta,
        SE = std.error,
        LCL = theta.conf.low,
        UCL = theta.conf.high
      )
    )
  )

kable(
  x = rmst_metadata_adj_table,
  caption = "TMLE covariate-adjusted estimates of Restricted Mean Survival Time.",
  digits = 2
)
```



#### Calculate Survival Probability

```{r tmle-survival-probability, results = 'asis', message = TRUE}
survival_metadata_adj <-
  adjrct::survprob(
    metadata = surv_metadata_adj,
    horizon = 60
  )

survival_metadata_adj
```

The covariate-adjusted survival probability in the first 60 months was 0.63 in the in the Lev+5FU arm and 0.53 in the observation arm. The difference in the probability of surviving the first 60 months between Lev+5FU and observation was 0.10 (i.e an 10% lower risk of dying in the first 60 months in the treatment arm relative to control). The point estimates and variance estimates are almost identical to the unadjusted estimates.


```{r tmle-adjusted-survival-format}
survival_metadata_adj_table <-
  with(
    survival_metadata_adj$estimates[[1]],

    bind_rows(
      data.frame(
        Arm = "Treatment",
        Estimate = arm1,
        SE = arm1.std.error,
        LCL = arm1.conf.low,
        UCL = arm1.conf.high
      ),

      data.frame(
        Arm = "Control",
        Estimate = arm0,
        SE = arm0.std.error,
        LCL = arm0.conf.low,
        UCL = arm0.conf.high
      ),
      data.frame(
        Arm = "Treatment - Control",
        Estimate = theta,
        SE = std.error,
        LCL = theta.conf.low,
        UCL = theta.conf.high
      )
    )
  )

kable(
  x = survival_metadata_adj_table,
  caption = "TMLE covariate-adjusted estimates of survival probability.",
  digits = 2
)
```
